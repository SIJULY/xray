#!/bin/bash
set -e

PORT=1080
USER="proxyuser"
PASS="proxypass"
CONF_PATH="/etc/opt/ss5/ss5.conf"
AUTH_PATH="/etc/opt/ss5/ss5.passwd"

echo "📦 安装 SS5（支持 SOCKS5 和 HTTP）..."
apt update
apt install -y gcc make libpam0g-dev libssl-dev iproute2 wget curl sudo

# 获取源码并编译安装 SS5
cd /tmp
wget https://github.com/MerlinKodo/ss5/archive/refs/heads/master.zip -O ss5.zip
unzip ss5.zip
cd ss5-master
./configure
make && make install

# 添加认证配置
echo "auth 0.0.0.0/0 - u" >> $CONF_PATH
echo "permit u $USER" >> $CONF_PATH
echo "$USER $PASS" > $AUTH_PATH
chmod 600 $AUTH_PATH

# 开启认证功能
sed -i 's/^auth.*$/auth    0.0.0.0\/0    -    u/' $CONF_PATH
sed -i 's/^permit.*$/permit u    '$USER'/' $CONF_PATH

# 创建服务文件
cat > /etc/systemd/system/ss5.service <<EOF
[Unit]
Description=SS5 Socks Server
After=network.target

[Service]
ExecStart=/usr/local/sbin/ss5 -u root
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
systemctl daemon-reexec
systemctl daemon-reload
systemctl enable ss5
systemctl restart ss5

# 获取公网 IP
IP=$(curl -s ifconfig.me)

echo "✅ SS5 安装完成"
echo "----------------------------------"
echo "地址: $IP"
echo "端口: $PORT"
echo "账号: $USER"
echo "密码: $PASS"
echo "协议: SOCKS5 / HTTP"
echo "----------------------------------"
